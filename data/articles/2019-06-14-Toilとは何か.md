---
layout: post
categories: blog
tags: [読書,技術,Site Reliability Engineering]
toc: true
---

[Eliminating Toil](https://landing.google.com/sre/sre-book/chapters/eliminating-toil/) を読んだ。

SRE の本を読むと、バックエンドサービスを運用している身として、共感してしまうことが多い。

しかしながら、Toil は先入観を持たずに、しっかりと理解した方が良い。
SRE の本を読む前は「Toil とは人間が手で行なう雑務」というイメージであった。・・・が、それはちょっと違う。

今回、Toil の洗い出し作業を実際にやってみたところ、とても難しかった。
何故か？

* どの作業が Toil であるか？の判断基準の設け方が難しい。
  * SRE の良いところは、明確な線引きが無いところであり、その組織の文化に合わせてやり方をカスタマイズできるところである。であるが故に、どの作業が Toil であるか？を判断する際に、一定に判断基準を設けておかなければならない。
  * 作業の粒度の設定が難しい。どの粒度で「１つの作業」と見なすのか？・・・悩んだ。

# Toil の定義

本の中で、定義は以下のように書かれている。

> Toil is the kind of work tied to running a production service that tends to be manual, repetitive, automatable, tactical, devoid of enduring value, and that scales linearly as a service grows.

この後に、具体的な説明が続く。

> the more closely work matches one or more of the following descriptions, the more likely it is to be toil

ある作業が以下に説明されているようなものに近いければ近いほど、その作業は Toil である可能性が高い。

* Manual（人間の手で行われるもの）
  * 例）サーバーの設定、スクリプトの起動。
* Repetitive
  * 繰り返し何度も実行される作業。
  * 但し、新しい問題を解決する作業は Toil ではない。
* Automatable
  * 人間の判断を必要とせず、自動化可能な作業。
* Tactical
  * 予期せず発生するような作業。
* No enduring value
  * その作業の完了後、作業前の状態に戻るような作業（例）リリース時のロールアウト等。
  * その作業の完了後、永続的な改善が成せるものであれば、Toil ではない。
* O(n) with service growth
  * サービスのサイズに比例し、線形増加する作業。
  * 理想的には、作業をしなくても、10倍程のスケールアップができるサービス設計があると良い。

## 考察

### tied to running a production service とは何か？

> tied to running a production service

Toil をプロジェクトに導入する場合、"tied to running a production service" とは何か？について認識を合わせておかなければならない。この時点で色々ともめそうだ・・・。どう考えるか・・・。

（どこかに書いてあったかもしれないけれど）自分なりに考えたところ、以下のようなものが良いと思った。

#### tied to running a production service を「サービスのSLOを維持するための作業」と訳す

#### 「サービスのSLOを維持するための作業」とは、その作業をしなかった場合、即時に、サービスがSLOを満たせなくなるような作業

ここでは、**将来的に**サービスがSLOを満たせなくなるような作業は除外した。
その理由は以下の2点。

* 将来を予測するスキルは、個人の経験や技術レベルに大きく依存する。そのため、「サービスのSLOを維持するための作業」の範囲について、個人間の議論が頻繁に勃発する。この議論がチームの開発速度を低下させる。
* 将来のことはいくらでも予測可能だ。そのため、「サービスのSLOを維持するための作業」をいくらでも思いつくことができ、議論の収集がつかない。この議論がチームの開発速度を低下させる。

「running a production service」を「サービスのSLOを維持するための作業」と訳した理由は以下。

* 「サービスの稼働」と訳した場合、「稼働」ってなんぞや？という、不毛な議論が勃発するため。

# 現在の業務を Toil と、そうでないものに分類

日常的に実施している作業の一部を Toil と、そうでないものに分類してみる。

この時、非常に悩んだのが、Toil の候補となる作業の粒度。
具体的には、(1)スクラムで洗い出されたタスクを１つの作業と見なすべきか？(2)そのタスクを実行する上で実施しなければならない作業を１つの作業と見なすべきか？(3)突発的に発生する作業を１つの作業と見なすべきか？という問題である。

粒度に関しては、(1)(2)(3)の全てを「作業」と見なすことにした。
かなり悩んだが、SRE 初心者の私には、適切な粒度がまだわからない。

**！！！注意点。あくまでも、私が現在所属している組織においての分類！！！多分、所属している組織によって、Toil とすべきかどうかの判断基準がかなり違ってくる**

## Toil であると判断されたもの

* スクラムのセレモニーで洗い出されたタスク
  * なし・・・。これで良いのか？
* タスクを実行する上で実施しなければならない作業
  * サービスをデプロイする（サービスアウト〜ソフトウェアのアップデート〜サービスイン）
  * サービスをスモークテストする
  * 対応作業履歴を残す
  * 開発環境を作成する
  * カバレッジを計測する
* 突発的に発生する作業
  * サーバーのハードウェア障害に対応する
  * XXXバッチがダウンする障害に対応する
  * ネットワークがダウンする障害に対応する
  * 関連する外部サービスがダウンする障害に対応する
  * スパイクに対応する
  * 利用者からの問い合わせ
  * ミドルウェアをアップデートする（脆弱性のあるソフトウェアのアップデート）
  * 障害対応履歴を残す

## Toil では無いと判断されたもの

* スクラムのセレモニーで洗い出されたタスク
  * 新機能XXXを追加する
  * サービスのリクエスト制限を外す
  * 既存機能を拡張する
  * サービスの利用相談チケット管理機構の刷新
  * サービスの負荷テストをする
  * サービスを他サービスと連携する
  * 物理サーバーをリプレイスする
  * サービスの新クラスタを構築する
  * API の開発
  * キャパシティプランニングする
  * データベースのデータを移行する（定期的では無い）
  * バグを修正する
  * サービスのドメインを切り替える
  * 監視システムを既存のものから移行する
  * 監視システムの項目を追加する
  * 不要となったコードを削除する
* タスクを実行する上で実施しなければならない作業
  * 永続的なドキュメントの更新（設計図、運用手順、etc...）
  * コーディングする
  * 利用者へ連絡する
  * 新しいソフトウェアを調査する
  * ミーティングする
* 突発的に発生する作業
  * ミーティングする

## 考察（なかなか難しい・・・）

### そもそも「サービスのSLOを維持するための作業」という定義は、外した方が・・・？

「サービスのSLOを維持するための作業」という定義を入れた場合、デプロイ作業とか、ユニットテストのカバレッジの計測作業、とかは Toil では無くなる。
しかしながら、これらの作業は、Toil として計上すべきであると思う。

SRE の本に書かれていることをそのまま真に受けない方が良いのか・・・？否、これらの作業は SRE チームがやるべきことではなく、開発チームがやるべきことなのか・・・？若干、混乱している。
私の認識が間違っているのかもしれない。

### 「作業」は「事前に計画されたタスク」ではない

Toil とは「作業」であり「事前に計画されたタスク」だけではない。
むしろ、タスクをこなすための細々とした作業が Toil となりうるし、突発的に発生しうる作業もそうである。
はじめのうち、Toil という概念に慣れていなかったので、「事前に計画されたタスク」から Toil を洗い出そうとしてしまった・・・。

### Toil の候補となる「作業」とは何か？の判断が難しい

「XXXみたいなものを Toil の候補となる作業と見なす！」と決め、そこから演繹的に Toil の候補を洗い出すという手法を取った場合、漏れが発生しそうで怖い。

したがって洗い出す際は、以下の戦略が良いと思う。

* ブレインストーミング形式で作業を雑多に洗い出す。
* 演繹的ではなく、帰納的な手法を取る。
  * （例）なんか最近、XXXの作業を繰り返しやってるよね。自動化できるんじゃね？

## Toil の解消には結局のところ何が鍵となるのか

結局のところ(1)DevOps (2)アラート対応・ユーザー対応のフローの整備or自動化、の2つが鍵となると思う。
何故なら、Toil の定義上、Toil として見なすことのできる作業の殆どは、以下の作業になると思うからだ。

まず第一に、定期的に発生する

* デプロイに関係する作業（テスト、デプロイ）

続いて、突発的に発生する

* アラート対応に伴う作業
* 利用者対応に伴う作業

ソフトウェアのアップデート作業などは、そのチームのマネージメントレベルが成熟していれば、突発的に発生する作業ではないかもしれない。

## その作業が Toil であるかどうか？はチームにより千差万別である

チームのマネジメント文化の成熟度、或いは、CI/CD 導入率などにより、Toil の数は変化する。
自らのチームを、ある程度時間をかけて冷静に分析しよう！というところか・・・。
